<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix | Segmented Seat Matrix</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon"
        href="https://raw.githubusercontent.com/nishatrhythm/Bangladesh-Railway-Train-and-Fare-List-with-Route-Map/main/images/bangladesh-railway.png">
</head>

<body>
    <div class="flyout-notification" id="flyoutNotification">
        <span id="flyoutMessage"></span>
        <i class="fas fa-times flyout-close" id="flyoutClose"></i>
    </div>
    <noscript>
        <div class="matrix-container noscript-warning">
            <h2><i class="fas fa-exclamation-circle"></i> Please Enable JavaScript</h2>
            <p>This website requires JavaScript to function properly. Enable it in your browser settings to access full
                functionality and check train seat availability.</p>
            <div class="instructions">
                <strong>How to enable:</strong> Go to your browser settings > Privacy/Security > Enable JavaScript.
                Refresh the page after enabling.
            </div>
        </div>
    </noscript>

    <div class="matrix-container">
        <h1><i class="fas fa-th-list"></i> Seat Matrix for {{ train_name }}</h1>

        <a href="/" class="btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Search
        </a>

        <div class="date-header">
            <h2><i class="fas fa-calendar-alt"></i> Journey Date: {{ date }}</h2>
            {% if has_segmented_dates %}
            <div class="travel-alert">
                <div class="alert-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Date Selection for Overnight Journey</h3>
                </div>
                <p>This train departs from its origin station on {{ date }}, but reaches certain stations after midnight
                    — in the early hours of {{ next_day_str }}. Ticket availability for those post-midnight arrivals may
                    appear under {{ next_day_str }}.</p>
                <div class="alert-tip">
                    <i class="fas fa-lightbulb"></i>
                    <p>Tip: To find tickets for arrivals early on {{ date }}, try searching with {{ prev_day_str }} as
                        your
                        journey date.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="route-card route-visualization-card">
            <details class="route-collapse">
                <summary class="route-toggle-btn">
                    <span class="route-toggle-text"><i class="fas fa-route"></i> Expand to view Train Route</span>
                    <i class="fas fa-chevron-down toggle-arrow"></i>
                </summary>

                <div class="route-body">
                    <div class="route-train-header">
                        <h3><i class="fas fa-subway"></i> {{ train_name }}</h3>
                        <div class="run-days-list">
                            <span class="run-days-title">Runs on:</span>
                            {% for day in ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'] %}
                            <span class="run-day {% if day not in days %}off{% endif %}">
                                {{ day }}{% if day not in days %}<sup>(off)</sup>{% endif %}
                            </span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="station-timeline">
                        {% for stop in routes %}
                        <div class="station-item {% if loop.first %}start{% elif loop.last %}end{% endif %}">
                            <div class="station-node">
                                <div class="station-icon-circle">
                                    <i class="fas fa-location-dot"></i>
                                </div>
                                {% if not loop.last %}
                                <div class="station-line"></div>
                                {% endif %}
                            </div>
                            <div class="station-info">
                                <div class="station-header">
                                    <div class="station-name">
                                        {{ stop.city }}
                                        {% if stop.display_date %}
                                        <span class="station-date">{{ stop.display_date }}</span>
                                        {% endif %}
                                    </div>
                                    {% if loop.first %}
                                    <span class="station-type-label start">Origin</span>
                                    {% elif loop.last %}
                                    <span class="station-type-label end">Destination</span>
                                    {% endif %}
                                </div>
                                <div class="station-meta-row">
                                    <div class="meta-item">
                                        <strong>Arrival:</strong>
                                        {% if stop.arrival_time %}
                                        {{ stop.arrival_time.replace(' BST', '') }}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Departure:</strong>
                                        {% if stop.departure_time %}
                                        {{ stop.departure_time.replace(' BST', '') }}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Halt:</strong>
                                        {% if stop.halt and stop.halt != '---' %}
                                        {{ stop.halt|int }} min
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Duration:</strong>
                                        {% if stop.duration and stop.duration != '---' %}
                                        {% set hours, minutes = stop.duration.split(':') %}
                                        {% set h = hours|int %}
                                        {% set m = minutes|int %}
                                        {% if h > 0 and m > 0 %}
                                        {{ h }} h {{ m }} min
                                        {% elif h > 0 %}
                                        {{ h }} h
                                        {% elif m > 0 %}
                                        {{ m }} min
                                        {% else %}
                                        ———
                                        {% endif %}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="total-journey-time">
                        <i class="fas fa-clock"></i> Total Duration:
                        {% if total_duration %}
                        {% set hours, minutes = total_duration.split(':') %}
                        {% set h = hours|int %}
                        {% set m = minutes|int %}
                        {% if h > 0 and m > 0 %}
                        {{ h }} h {{ m }} min
                        {% elif h > 0 %}
                        {{ h }} h
                        {% else %}
                        {{ m }} min
                        {% endif %}
                        {% else %}
                        ———
                        {% endif %}
                    </div>
                </div>
            </details>
        </div>

        {% for seat_type in seat_types %}
        {% if has_data_map[seat_type] %}
        {% set matrix = fare_matrices[seat_type] %}
        <div class="matrix-card">
            <h3><i class="fas fa-chair"></i> Seat Type: {{ seat_type }}</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>From → To</th>
                            {% for col in stations %}<th>{{ col }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for from_station in stations %}
                        <tr>
                            <td><strong>{{ from_station }}</strong></td>
                            {% for to_station in stations %}
                            {% if stations.index(from_station) >= stations.index(to_station) %}
                            <td class="disabled-cell"></td>
                            {% else %}
                            {% set cell = matrix[from_station].get(to_station) %}
                            {% if cell and (cell.online + cell.offline) > 0 %}
                            {# Convert station_dates[from_station] (YYYY-MM-DD) to DD-MMM-YYYY #}
                            {% set doj = station_dates_formatted.get(from_station, date) %}
                            <td class="available">
                                <div class="cell-content">
                                    <span class="seat-count">{{ cell.online + cell.offline }}</span>
                                    <span class="fare"><span class="taka-icon">৳</span><span class="fare-value">{{
                                            (cell.fare + cell.vat_amount) | int }}</span></span>
                                    <a href="https://eticket.railway.gov.bd/booking/train/search?fromcity={{ from_station }}&tocity={{ to_station }}&doj={{ doj }}&class={{ seat_type }}"
                                        class="buy-link" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Buy
                                    </a>
                                </div>
                            </td>
                            {% else %}
                            <td class="disabled-cell"></td>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <div class="ca-check-availability-section">
            <h2><i class="fas fa-search"></i> টিকিট পাওয়া যাচ্ছে কিনা দেখুন</h2>
            <form id="ca-availability-form" class="ca-availability-form">
                <div class="ca-form-row">
                    <div class="ca-form-group">
                        <label for="ca-origin-station-input">যাত্রা শুরুর স্টেশন</label>
                        <div class="ca-input-with-icon ca-custom-dropdown" id="ca-origin-station-dropdown">
                            <i class="fas fa-train ca-input-icon"></i>
                            <input type="text" id="ca-origin-station-input" placeholder="Select from station"
                                autocomplete="off" readonly>
                            <input type="hidden" id="ca-origin-station" name="ca_origin_station">
                            <div class="ca-dropdown-menu" id="ca-origin-station-menu" style="display: none;">
                                <div class="ca-dropdown-options" id="ca-origin-station-options">
                                    {% for station in stations %}
                                    <div class="ca-dropdown-option" data-value="{{ station }}">{{ station }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <span class="ca-error-message" id="ca-origin-station-error">শুরু স্টেশনটি প্রয়োজন</span>
                    </div>
                    <div class="swap-icon-wrapper" id="ca-swap-button" title="Swap stations">
                        <i class="fas fa-exchange-alt swap-icon"></i>
                    </div>
                    <div class="ca-form-group">
                        <label for="ca-destination-station-input">গন্তব্য স্টেশন</label>
                        <div class="ca-input-with-icon ca-custom-dropdown" id="ca-destination-station-dropdown">
                            <i class="fas fa-train ca-input-icon"></i>
                            <input type="text" id="ca-destination-station-input"
                                placeholder="Select to station" autocomplete="off" readonly>
                            <input type="hidden" id="ca-destination-station" name="ca_destination_station">
                            <div class="ca-dropdown-menu" id="ca-destination-station-menu" style="display: none;">
                                <div class="ca-dropdown-options" id="ca-destination-station-options">
                                    {% for station in stations %}
                                    <div class="ca-dropdown-option" data-value="{{ station }}">{{ station }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <span class="ca-error-message" id="ca-destination-station-error">গন্তব্য স্টেশন প্রয়োজন</span>
                    </div>
                </div>
                <div class="ca-form-group ca-submit-btn">
                    <button type="submit" class="ca-btn-primary">
                        <i class="fas fa-search"></i> চেক করুন
                    </button>
                </div>
                <p class="ca-info-text">
                    <i class="fas fa-info-circle"></i>
                    টিকিট খালি থাকার তথ্যটি আপনার আগের দেখা তালিকার ওপর ভিত্তি করে দেখানো হচ্ছে। সবথেকে সঠিক ও নতুন তথ্য দেখতে, দয়া করে আবার তালিকাটি তৈরি করুন
                </p>
            </form>
            <div class="ca-route-results" id="ca-route-results" style="display: none;">
                <!-- Results will be dynamically inserted here -->
            </div>
        </div>

        <a href="/" class="btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Search
        </a>
    </div>

    <button id="backToTopBtn">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="/static/js/script.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const tables = document.querySelectorAll(".table-responsive");

            tables.forEach(table => {
                let isDown = false;
                let startX;
                let startY;
                let scrollLeft;
                let scrollTop;

                table.addEventListener("mousedown", (e) => {
                    isDown = true;
                    table.classList.add("dragging");
                    startX = e.pageX - table.offsetLeft;
                    startY = e.pageY - table.offsetTop;
                    scrollLeft = table.scrollLeft;
                    scrollTop = table.scrollTop;
                    e.preventDefault();
                });

                table.addEventListener("mouseleave", () => {
                    isDown = false;
                    table.classList.remove("dragging");
                });

                table.addEventListener("mouseup", () => {
                    isDown = false;
                    table.classList.remove("dragging");
                });

                table.addEventListener("mousemove", (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - table.offsetLeft;
                    const y = e.pageY - table.offsetTop;
                    const walkX = (x - startX);
                    const walkY = (y - startY);
                    table.scrollLeft = scrollLeft - walkX;
                    table.scrollTop = scrollTop - walkY;
                });
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const details = document.querySelector(".route-collapse");
            const textSpan = details.querySelector(".route-toggle-text");
            const icon = details.querySelector(".toggle-arrow");

            const updateText = () => {
                if (details.open) {
                    textSpan.innerHTML = '<i class="fas fa-route"></i> Collapse to hide Train Route';
                    icon.style.transform = "rotate(180deg)";
                } else {
                    textSpan.innerHTML = '<i class="fas fa-route"></i> Expand to view Train Route';
                    icon.style.transform = "rotate(0deg)";
                }
            };

            updateText();

            details.addEventListener("toggle", updateText);
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const detailsElements = document.querySelectorAll('.route-visualization-card details');

            detailsElements.forEach(details => {
                const toggleBtn = details.querySelector('.route-toggle-btn');
                const routeBody = details.querySelector('.route-body');

                const updateContentHeight = () => {
                    routeBody.style.height = 'auto';
                    const height = routeBody.scrollHeight;
                    routeBody.style.height = details.open ? `${height}px` : '0';
                    return height;
                };

                requestAnimationFrame(() => {
                    if (details.open) {
                        routeBody.style.height = `${updateContentHeight()}px`;
                        routeBody.style.opacity = '1';
                    }
                });

                toggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();

                    if (details.hasAttribute('open')) {
                        routeBody.style.height = `${routeBody.scrollHeight}px`;
                        requestAnimationFrame(() => {
                            routeBody.style.height = '0';
                            routeBody.style.opacity = '0';
                        });
                        setTimeout(() => {
                            details.removeAttribute('open');
                        }, 400);
                    } else {
                        details.setAttribute('open', '');
                        routeBody.style.height = '0';
                        routeBody.style.opacity = '0';
                        requestAnimationFrame(() => {
                            const height = routeBody.scrollHeight;
                            routeBody.style.height = `${height}px`;
                            routeBody.style.opacity = '1';
                        });
                        setTimeout(() => {
                            routeBody.style.height = 'auto';
                        }, 400);
                    }
                });
                window.addEventListener('resize', () => {
                    if (details.open) {
                        routeBody.style.height = 'auto';
                        routeBody.style.height = `${routeBody.scrollHeight}px`;
                    }
                });
            });
        });
    </script>
    <script>
        setTimeout(function() {
            window.location.href = '/';
        }, 300000);
    </script>
    <script>
        function setupAvailabilityDropdowns() {
            ['origin', 'destination'].forEach(type => {
                const dropdown = document.getElementById(`ca-${type}-station-dropdown`);
                const textInput = document.getElementById(`ca-${type}-station-input`);
                const dropdownMenu = document.getElementById(`ca-${type}-station-menu`);
                const optionsContainer = document.getElementById(`ca-${type}-station-options`);
                const hiddenInput = document.getElementById(`ca-${type}-station`);
                const errorField = document.getElementById(`ca-${type}-station-error`);
                let allOptions = Array.from(optionsContainer.querySelectorAll('.ca-dropdown-option'));

                function updateDropdownOptions() {
                    const otherInput = type === 'origin' ? document.getElementById('ca-destination-station') : document.getElementById('ca-origin-station');
                    const otherValue = otherInput.value.trim();
                    allOptions.forEach(option => {
                        const isHidden = otherValue && option.dataset.value === otherValue;
                        option.style.display = isHidden ? 'none' : 'block';
                    });
                    focusedOptionIndex = -1;
                    updateFocusedOption();
                }

                function openDropdown() {
                    dropdownMenu.style.display = 'block';
                    updateDropdownOptions();
                    focusedOptionIndex = -1;
                }

                function closeDropdown() {
                    dropdownMenu.classList.add('fade-out');
                    setTimeout(() => {
                        dropdownMenu.style.display = 'none';
                        dropdownMenu.classList.remove('fade-out');
                        focusedOptionIndex = -1;
                        updateFocusedOption();
                    }, 200);
                }

                function selectOption(option) {
                    const value = option.dataset.value;
                    textInput.value = value;
                    hiddenInput.value = value;
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    closeDropdown();

                    if (errorField.classList.contains('show')) {
                        errorField.classList.remove('show');
                        errorField.classList.add('hide');
                        textInput.classList.remove('error-input');
                    }

                    updateDropdownOptions();
                    const otherDropdown = type === 'origin' ? document.getElementById('ca-destination-station-dropdown') : document.getElementById('ca-origin-station-dropdown');
                    const otherMenu = otherDropdown.querySelector('.ca-dropdown-menu');
                    if (otherMenu.style.display === 'block') {
                        updateDropdownOptions();
                    }
                }

                function updateFocusedOption() {
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    const visibleOptions = allOptions.filter(opt => opt.style.display !== 'none');
                    if (focusedOptionIndex >= 0 && focusedOptionIndex < visibleOptions.length) {
                        visibleOptions[focusedOptionIndex].classList.add('selected');
                        visibleOptions[focusedOptionIndex].scrollIntoView({ block: 'nearest' });
                    }
                }

                textInput.addEventListener('click', openDropdown);

                textInput.addEventListener('keydown', (e) => {
                    const visibleOptions = allOptions.filter(opt => opt.style.display !== 'none');
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (focusedOptionIndex < visibleOptions.length - 1) {
                            focusedOptionIndex++;
                            updateFocusedOption();
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (focusedOptionIndex > 0) {
                            focusedOptionIndex--;
                            updateFocusedOption();
                        }
                    } else if (e.key === 'Enter' && focusedOptionIndex >= 0) {
                        e.preventDefault();
                        selectOption(visibleOptions[focusedOptionIndex]);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        closeDropdown();
                    }
                });

                allOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        selectOption(option);
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target)) closeDropdown();
                });
            });

            const swapButton = document.getElementById('ca-swap-button');
            swapButton.addEventListener('click', () => {
                const originInput = document.getElementById('ca-origin-station-input');
                const destinationInput = document.getElementById('ca-destination-station-input');
                const originHidden = document.getElementById('ca-origin-station');
                const destinationHidden = document.getElementById('ca-destination-station');

                const tempValue = originInput.value;
                const tempHiddenValue = originHidden.value;

                originInput.value = destinationInput.value;
                originHidden.value = destinationHidden.value;
                destinationInput.value = tempValue;
                destinationHidden.value = tempHiddenValue;

                ['origin', 'destination'].forEach(type => {
                    const textInput = document.getElementById(`ca-${type}-station-input`);
                    const hiddenInput = document.getElementById(`ca-${type}-station`);
                    const optionsContainer = document.getElementById(`ca-${type}-station-options`);
                    const allOptions = Array.from(optionsContainer.querySelectorAll('.ca-dropdown-option'));
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    if (hiddenInput.value) {
                        const selectedOption = allOptions.find(opt => opt.dataset.value === hiddenInput.value);
                        if (selectedOption) selectedOption.classList.add('selected');
                    }
                });

                const resultsContainer = document.getElementById('ca-route-results');
                resultsContainer.style.display = 'none';
                resultsContainer.innerHTML = '';

                swapButton.classList.add('rotate');
                setTimeout(() => {
                    swapButton.classList.remove('rotate');
                }, 400);
            });
        }

        function findRoutes(origin, destination, seatType, stations, fareMatrices) {
            const queue = [[origin, [], 0]];
            const visited = new Set();

            while (queue.length) {
                const [currentStation, path, totalFare] = queue.shift();

                if (visited.has(currentStation)) continue;
                visited.add(currentStation);

                if (currentStation === destination) return [path, totalFare];

                const currentIndex = stations.indexOf(currentStation);
                for (let i = currentIndex + 1; i < stations.length; i++) {
                    const nextStation = stations[i];
                    const seatInfo = fareMatrices[seatType][currentStation][nextStation];
                    if (seatInfo && seatInfo.online > 0) {
                        const nextFare = parseFloat(seatInfo.fare);
                        const vatAmount = parseFloat(seatInfo.vat_amount || 0);
                        const charge = 20;
                        const totalCost = nextFare + vatAmount + charge;
                        const newPath = [...path, {
                            from: currentStation,
                            to: nextStation,
                            base: nextFare,
                            vat: vatAmount,
                            charge: charge,
                            total: totalCost,
                            seats: seatInfo.online + seatInfo.offline,
                            date: window.stationDates[currentStation]
                        }];
                        queue.push([nextStation, newPath, totalFare + totalCost]);
                    }
                }
            }
            return null;
        }

        function findMixedRoutes(origin, destination, stations, fareMatrices, seatTypes) {
            const queue = [[origin, [], 0]];
            const visited = new Set();

            while (queue.length) {
                const [currentStation, path, totalFare] = queue.shift();

                if (visited.has(currentStation)) continue;
                visited.add(currentStation);

                if (currentStation === destination) return [path, totalFare];

                const currentIndex = stations.indexOf(currentStation);
                for (let i = currentIndex + 1; i < stations.length; i++) {
                    const nextStation = stations[i];
                    let bestSegment = null;
                    for (const seatType of seatTypes) {
                        const seatInfo = fareMatrices[seatType][currentStation][nextStation];
                        if (seatInfo && seatInfo.online > 0) {
                            bestSegment = { seatType, seatInfo };
                            break;
                        }
                    }

                    if (bestSegment) {
                        const { seatType, seatInfo } = bestSegment;
                        const base = parseFloat(seatInfo.fare);
                        const vat = parseFloat(seatInfo.vat_amount || 0);
                        const charge = 20;
                        const total = base + vat + charge;
                        const seg = {
                            from: currentStation,
                            to: nextStation,
                            seatType: seatType,
                            base: base,
                            vat: vat,
                            charge: charge,
                            total: total,
                            seats: seatInfo.online + seatInfo.offline,
                            date: window.stationDates[currentStation]
                        };
                        queue.push([nextStation, [...path, seg], totalFare + total]);
                    }
                }
            }
            return null;
        }

        function validateAvailabilityForm(event) {
            event.preventDefault();
            let isValid = true;
            let firstEmptyField = null;
            const validations = [
                { id: 'ca-origin-station', errorId: 'ca-origin-station-error', inputId: 'ca-origin-station-input', message: 'From station is required' },
                { id: 'ca-destination-station', errorId: 'ca-destination-station-error', inputId: 'ca-destination-station-input', message: 'To station is required' }
            ];

            validations.forEach(validation => {
                const inputField = document.getElementById(validation.id);
                const textInput = document.getElementById(validation.inputId);
                const errorField = document.getElementById(validation.errorId);
                if (inputField.value.trim() === "") {
                    errorField.textContent = validation.message;
                    errorField.style.display = "block";
                    errorField.classList.remove('hide');
                    errorField.classList.add('show');
                    textInput.classList.add('error-input');
                    if (!firstEmptyField) firstEmptyField = textInput;
                    isValid = false;
                } else {
                    errorField.classList.remove('show');
                    errorField.classList.add('hide');
                    textInput.classList.remove('error-input');
                }
            });

            if (!isValid) {
                firstEmptyField.focus();
                return false;
            }

            const origin = document.getElementById('ca-origin-station').value;
            const destination = document.getElementById('ca-destination-station').value;
            const resultsContainer = document.getElementById('ca-route-results');

            if (origin === destination) {
                resultsContainer.style.display = 'block';
                resultsContainer.innerHTML = `
                    <div class="ca-invalid-route-message">
                        <i class="fas fa-exclamation-circle"></i>
                        Origin and destination stations cannot be the same.
                    </div>
                `;
                document.querySelector('.ca-check-availability-section').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                return false;
            }

            if (stations.indexOf(origin) >= stations.indexOf(destination)) {
                resultsContainer.style.display = 'block';
                resultsContainer.innerHTML = `
                    <div class="ca-invalid-route-message">
                        <i class="fas fa-exclamation-circle"></i>
                        The 'From' station must be earlier than the 'To' station in the train's route.
                    </div>
                `;
                document.querySelector('.ca-check-availability-section').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                return false;
            }

            return true;
        }

        function displayAvailabilityResults() {
            const form = document.getElementById('ca-availability-form');
            const resultsContainer = document.getElementById('ca-route-results');
            const origin = document.getElementById('ca-origin-station').value;
            const destination = document.getElementById('ca-destination-station').value;

            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'block';

            let hasResults = false;
            const seatTypes = window.seatTypes;
            const fareMatrices = window.fareMatrices;
            const stations = window.stations;

            seatTypes.forEach(seatType => {
                const hasSeats = Object.keys(fareMatrices[seatType]).some(from =>
                    Object.values(fareMatrices[seatType][from]).some(info => (info.online + info.offline) > 0)
                );
                if (!hasSeats) return;

                const directRoute = fareMatrices[seatType][origin][destination];
                if (directRoute && directRoute.online > 0) {
                    const base = parseInt(directRoute.fare);
                    const vat = parseInt(directRoute.vat_amount || 0);
                    const charge = 20;
                    const total = base + vat + charge;
                    const seats = directRoute.online + directRoute.offline;
                    const date = window.stationDatesFormatted[origin] || window.date;

                    resultsContainer.innerHTML += `
                        <div class="ca-route-result-card">
                            <div class="ca-route-badge direct">Direct Ticket <span class="ca-seat-type-label">${seatType}</span></div>
                            <div class="ca-route-segment">
                                <div class="ca-route-segment-header">${origin} to ${destination}</div>
                                <div class="ca-fare-breakdown">
                                    <div class="ca-fare-item"><i class="fas fa-coins"></i> <strong>Base Fare:</strong> ${base} <span class="bdt">BDT</span></div>
                                    ${vat ? `<div class="ca-fare-item"><i class="fas fa-receipt"></i> <strong>VAT:</strong> ${vat} <span class="bdt">BDT</span></div>` : ''}
                                    <div class="ca-fare-item"><i class="fas fa-money-bill"></i> <strong>Charge:</strong> ${charge} <span class="bdt">BDT</span></div>
                                    <div class="ca-fare-item ca-fare-item-total"><i class="fas fa-calculator"></i> <strong>Total:</strong> ${total} <span class="bdt">BDT</span></div>
                                </div>
                                <div class="ca-ticket-action">
                                    <div class="ca-ticket-availability"><i class="fas fa-ticket-alt"></i> Available Tickets: <span>${seats}</span></div>
                                    <a href="https://eticket.railway.gov.bd/booking/train/search?fromcity=${origin}&tocity=${destination}&doj=${date}&class=${seatType}" class="ca-btn-primary buy-link" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Buy
                                    </a>
                                </div>
                            </div>
                            <div class="ca-grand-total"><i class="fas fa-wallet"></i> Grand Total: ${total} BDT</div>
                        </div>
                    `;
                    hasResults = true;
                } else {
                    const result = findRoutes(origin, destination, seatType, stations, fareMatrices);
                    if (result) {
                        const [segments, totalFare] = result;
                        const allSameDay = new Set(segments.map(seg => seg.date)).size === 1;
                        let segmentHtml = '';
                        segments.forEach(seg => {
                            segmentHtml += `
                                <div class="ca-route-segment">
                                    <div class="ca-route-segment-header">
                                        ${seg.from} to ${seg.to}
                                        ${!allSameDay ? `<span class="ca-route-segment-date">${new Date(seg.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-')}</span>` : ''}
                                    </div>
                                    <div class="ca-fare-breakdown">
                                        <div class="ca-fare-item"><i class="fas fa-coins"></i> <strong>Base Fare:</strong> ${seg.base} <span class="bdt">BDT</span></div>
                                        ${seg.vat ? `<div class="ca-fare-item"><i class="fas fa-receipt"></i> <strong>VAT:</strong> ${seg.vat} <span class="bdt">BDT</span></div>` : ''}
                                        <div class="ca-fare-item"><i class="fas fa-money-bill"></i> <strong>Charge:</strong> ${seg.charge} <span class="bdt">BDT</span></div>
                                        <div class="ca-fare-item ca-fare-item-total"><i class="fas fa-calculator"></i> <strong>Total:</strong> ${seg.total} <span class="bdt">BDT</span></div>
                                    </div>
                                    <div class="ca-ticket-action">
                                        <div class="ca-ticket-availability"><i class="fas fa-ticket-alt"></i> Available Tickets: <span>${seg.seats}</span></div>
                                        <a href="https://eticket.railway.gov.bd/booking/train/search?fromcity=${seg.from}&tocity=${seg.to}&doj=${new Date(seg.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-')}&class=${seatType}" class="ca-btn-primary buy-link" target="_blank">
                                            <i class="fas fa-external-link-alt"></i> Buy
                                        </a>
                                    </div>
                                </div>
                            `;
                        });

                        resultsContainer.innerHTML += `
                            <div class="ca-route-result-card">
                                <div class="ca-route-badge segmented">Segmented Tickets <span class="ca-seat-type-label">${seatType}</span></div>
                                ${segmentHtml}
                                <div class="ca-grand-total"><i class="fas fa-wallet"></i> Grand Total: ${totalFare} BDT</div>
                            </div>
                        `;
                        hasResults = true;
                    }
                }
            });

            if (!hasResults) {
                const mixedResult = findMixedRoutes(origin, destination, stations, fareMatrices, seatTypes);
                if (mixedResult) {
                    const [segments, totalFare] = mixedResult;
                    const allSameDay = new Set(segments.map(seg => seg.date)).size === 1;
                    let segmentHtml = '';
                    segments.forEach(seg => {
                        segmentHtml += `
                            <div class="ca-route-segment">
                                <div class="ca-route-segment-header">
                                    ${seg.from} to ${seg.to} [${seg.seatType}]
                                    ${!allSameDay ? `<span class="ca-route-segment-date">starts ${new Date(seg.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-')}</span>` : ''}
                                </div>
                                <div class="ca-fare-breakdown">
                                    <div class="ca-fare-item"><i class="fas fa-coins"></i> <strong>Base Fare:</strong> ${seg.base} <span class="bdt">BDT</span></div>
                                    ${seg.vat ? `<div class="ca-fare-item"><i class="fas fa-receipt"></i> <strong>VAT:</strong> ${seg.vat} <span class="bdt">BDT</span></div>` : ''}
                                    <div class="ca-fare-item"><i class="fas fa-money-bill"></i> <strong>Charge:</strong> ${seg.charge} <span class="bdt">BDT</span></div>
                                    <div class="ca-fare-item ca-fare-item-total"><i class="fas fa-calculator"></i> <strong>Total:</strong> ${seg.total} <span class="bdt">BDT</span></div>
                                </div>
                                <div class="ca-ticket-action">
                                    <div class="ca-ticket-availability"><i class="fas fa-ticket-alt"></i> Available Tickets: <span>${seg.seats}</span></div>
                                    <a href="https://eticket.railway.gov.bd/booking/train/search?fromcity=${seg.from}&tocity=${seg.to}&doj=${new Date(seg.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-')}&class=${seg.seatType}" class="ca-btn-primary buy-link" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Buy
                                    </a>
                                </div>
                            </div>
                        `;
                    });

                    const seatTypeLabels = [...new Set(segments.map(seg => seg.seatType))].join(', ');
                    resultsContainer.innerHTML += `
                        <div class="ca-route-result-card">
                            <div class="ca-route-badge mixed">Mixed Segmented Tickets <span class="ca-seat-type-label">${seatTypeLabels}</span></div>
                            ${segmentHtml}
                            <div class="ca-grand-total"><i class="fas fa-wallet"></i> Grand Total: ${totalFare} BDT</div>
                        </div>
                    `;
                    hasResults = true;
                }
            }

            if (!hasResults) {
                resultsContainer.innerHTML = `
                    <div class="ca-no-route-message">
                        <i class="fas fa-exclamation-circle"></i>
                        No direct, segmented, or mixed-seat-type tickets are available between ${origin} and ${destination}.
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupAvailabilityDropdowns();
            const availabilityForm = document.getElementById('ca-availability-form');
            if (availabilityForm) {
                availabilityForm.addEventListener('submit', (event) => {
                    if (validateAvailabilityForm(event)) {
                        displayAvailabilityResults();
                        document.querySelector('.ca-check-availability-section').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            }

            document.querySelectorAll('.ca-error-message').forEach(function(errorField) {
                errorField.addEventListener('animationend', function(event) {
                    if (event.animationName === 'fadeOutScale' && errorField.classList.contains('hide')) {
                        errorField.style.display = 'none';
                        errorField.classList.remove('hide');
                    }
                });
            });

            window.stations = {{ stations | tojson }};
            window.seatTypes = {{ seat_types | tojson }};
            window.fareMatrices = {{ fare_matrices | tojson }};
            window.stationDates = {{ station_dates | tojson }};
            window.stationDatesFormatted = {{ station_dates_formatted | tojson }};
            window.date = {{ date | tojson }};
        });
    </script>
    <script>
        (function setupBackToTopButton() {
            const btn = document.getElementById('backToTopBtn');
            if (!btn) return;

            let hideTimeout;
            let lastScrollY = window.scrollY;

            function showButton() {
                btn.classList.add('visible');
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    btn.classList.remove('visible');
                }, 5000);
            }

            function handleScroll() {
                const scrollY = window.scrollY;
                if (scrollY > 300) {
                    if (scrollY !== lastScrollY) showButton();
                } else {
                    btn.classList.remove('visible');
                }
                lastScrollY = scrollY;
            }

            btn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            window.addEventListener('scroll', handleScroll);
        })();
    </script>
</body>

</html>